<!DOCTYPE html>
<html>

    <head>
	<link rel="stylesheet" type="text/css" href="main.css">
	<script src="main.js"></script>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet"
	      href="https://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
	      integrity="sha384-pdapHxIh7EYuwy6K7iE41uXVxGCXY0sAjBzaElYGJUrzwodck3Lx6IE2lA0rFREo"
	      crossorigin="anonymous">
	<link rel="stylesheet"
	      href="https://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css"
	      integrity="sha384-aUGj/X2zp5rLCbBxumKTCw2Z50WgIr1vs/PFN4praOTvYXWlVyh2UtNUU0KAUhAX"
	      crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"
		     integrity="sha384-R4/ztc4ZlRqWjqIuvf6RX5yb/v90qNGx6fS48N0tRxiGkqveZETq72KgDVJCp2TC"
		crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/1000hz-bootstrap-validator/0.11.9/validator.js"
		integrity="sha256-UiqIqgNXwR8ChFMaD8VrY0tBUIl/soqb7msaauJWZVc="
		crossorigin="anonymous"></script>

	<title>IPv4 Address Explorer</title>
    </head>

    <body>
	<header>
            <h1>IPv4 Address Explorer</h1></header>
	<template id="ipv4-address">
            <table class="table">
		<tr class="success">
                    <td colspan="2"><span class="description"></span></td>
		</tr>
		<tr>
                    <td class="active">Dotted Decimal</td>
                    <td><span class="dotted-decimal"></span></td>
		</tr>
		<tr>
                    <td class="active">Dotted Binary</td>
                    <td><span class="dotted-binary"></span></td>
		</tr>
		<tr class="info">
                    <td colspan="2"><span class="comment"></span></td>
		</tr>
            </table>
	    <ht>
	</template>

	<div class="container" id="main-container">
            <h4>Dotted Decimal</h4>
            <!-- Bootstrap form -->
            <form id="ip-form" class="form" role="form" data-toggle="validator">
		<div class="form-group">
                    <label class="sr-only" for="input-dec">Input Address</label>
                    <input type="text" class="form-control" id="input-dec"
			   placeholder="192.168.0.1/24"
			   pattern="[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\/([0-9]|1[0-9]|2[0-9]|30)"
			   data-error="🖐 Enter a valid IPv4 Address using CIDR notation." required>
                    <div class="help-block with-errors"></div>
		</div>
		<input type="submit" class="btn btn-primary">
		<input type="reset" class="btn btn-warning">
            </form>

            <h4>Input Summary</h4>
            <table class="table">
		<tr class="success">
                    <td colspan="2"><span class="description">Input Address</span></td>
		</tr>
		<tr>
                    <td class="active">Dotted Decimal</td>
                    <td><span id="user-dec" class="dotted-decimal"></span></td>
		</tr>
		<tr>
                    <td class="active">Subnet Mask</td>
                    <td><span id="user-subnet" class="dotted-decimal"></span></td>
		</tr>
		<tr>
                    <td class="active">Dotted Binary</td>
                    <td><span id="user-bin" class="dotted-binary"></span></td>
		</tr>
            </table>
            <hr>
            <h4>Output Summary</h4>
            <div id="output-container"></div>
            <footer>
		<ul>
                    <li class="list-group-item">Created by Forrest Smith</li>
		    <li class="list-group-item"><a href="https://github.com/ephsmith/ipv4explore">View on GitHub</a>.</li>
                    <li class="list-group-item">Utilizes <a href="https://github.com/beaugunderson">@beaugunderson</a>'s <a href="https://github.com/beaugunderson/ip-address">ip-address</a> library for address validation.
                    </li>
		</ul>
            </footer>
	</div>
	<script>
         $(document).ready(function() {
             $("form").submit(function(e) {
                 e.preventDefault();
                 $("#output-container").empty();
                 $("#user-dec").empty();
                 $("#user-bin").empty();
                 $("#user-subnet").empty();
                 explore();
             });
             $('form').on('reset', function(e) {
                 $("#output-container").empty();
                 $("#user-dec").empty();
                 $("#user-bin").empty();
                 $("#user-subnet").empty();
             });
         });

         function highlight_net(binstr, prefix) {
             /* highlights characters in binstr according to prefix
		(assumed to be a prefix length)
	      */
             b = binstr.split("");
             out = b.map(function(bit, idx) {
                 if ((idx != 31) && ((idx + 1) % 8 == 0)) {
                     dot = ".";
                 } else {
                     dot = "";
                 }
                 if (idx < prefix) {
                     return ("<span class='highlight'>" + bit + "</span>" + dot);
                 } else {
                     return (bit + dot);
                 }
             }).join("");
             return (out);
         }

         function explore() {

             var input_dec = $('#input-dec')[0].value;
             console.log("input_dec: " + input_dec);
             ip = new ipa.Address4(input_dec);
             var prefix = ip.subnetMask;

             console.log(ip);
             ip_bits = ip.getBitsBase2();
             out_bits = highlight_net(ip_bits, prefix);
             console.log(out_bits);
             $('#user-dec')[0].innerText = ip.addressMinusSuffix;
             $('#user-bin')[0].innerHTML = out_bits;
             $('#user-subnet')[0].innerText = bin_to_dot_dec(prefix_mask(prefix));

             function pad_bits(s) {
                 /* prepends string s with n-s.length 0's*/
                 return ("0".repeat(32 - s.length) + s);
             }

             function dot_bin(s) {
                 /* returns a dotted binary version of s */
                 return (s.match(/.{1,8}/g).join("."));
             }

             function bin_to_dot_dec(s) {
                 /* returns a dotted decimal representation form
                    of input binary string s.
                  */
                 s = dot_bin(s);
                 var b = s.split(".");
                 d = b.map(function(oct, idx) {
                     return (parseInt(oct, 2).toString())
                 });
                 return (d.join("."));
             }

             function prefix_mask(p) {
                 /* returns a binary string with p leading 1's
                    and 32-p trailing 0's.
                  */
                 return ("1".repeat(p) + "0".repeat(32 - p));
             }

             /* ip-address.js calls the network address the first
		or start address
              */
             net_dec = ip.startAddress().address;
             net_bits = ip.startAddress().getBitsBase2();

             /* Get first address from network address */
             first_int = parseInt(net_bits, 2) + 1;
             first_bits = pad_bits(first_int.toString(2));
             first_dec = bin_to_dot_dec(first_bits);

             /* Get the broadcast address ip-address.js calls this the
		last address.
	      */
             bcast_dec = ip.endAddress().address;
             bcast_bits = ip.endAddress().getBitsBase2();

             /* Get the last usable address from the broacast address */
             last_int = parseInt(bcast_bits, 2) - 1;
             last_bits = pad_bits(last_int.toString(2));
             last_dec = bin_to_dot_dec(last_bits);

             var tmpl = $("#ipv4-address")[0].content.cloneNode(true);
             tmpl.querySelector(".description").innerText = "Network Address";
             tmpl.querySelector(".dotted-decimal").innerText = net_dec;
             tmpl.querySelector(".dotted-binary").innerHTML = highlight_net(net_bits, prefix);
             tmpl.querySelector(".comment").innerText = "Host bits are zero in the net address."
             $("#output-container")[0].appendChild(tmpl);

             var tmpl = $("#ipv4-address")[0].content.cloneNode(true);
             tmpl.querySelector(".description").innerText = "First usable address";
             tmpl.querySelector(".dotted-decimal").innerText = first_dec;
             tmpl.querySelector(".dotted-binary").innerHTML = highlight_net(first_bits, prefix);
             tmpl.querySelector(".comment").innerText = "Equal to the network address plus 1."
             $("#output-container")[0].appendChild(tmpl);

             var tmpl = $("#ipv4-address")[0].content.cloneNode(true);
             tmpl.querySelector(".description").innerText = "Last usable address";
             tmpl.querySelector(".dotted-decimal").innerText = last_dec;
             tmpl.querySelector(".dotted-binary").innerHTML = highlight_net(last_bits, prefix);
             tmpl.querySelector(".comment").innerText = "Equal to the broadcast address minus 1."
             $("#output-container")[0].appendChild(tmpl);

             var tmpl = $("#ipv4-address")[0].content.cloneNode(true);
             tmpl.querySelector(".description").innerText = "Broadcast address";
             tmpl.querySelector(".dotted-decimal").innerText = bcast_dec;
             tmpl.querySelector(".dotted-binary").innerHTML = highlight_net(bcast_bits, prefix);
             tmpl.querySelector(".comment").innerText = "All host bits are 1."
             $("#output-container")[0].appendChild(tmpl);

         }

         function reset() {
             $("#output-container").empty();
             $("#user-dec").empty();
             $("#user-bin").empty();
             $("#user-subnet").empty();
             $('form').get(0).reset();
         }
	</script>

    </body>

</html>
